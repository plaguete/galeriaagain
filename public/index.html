<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galeria Especial</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Efeito de scanlines -->
  <div class="scanlines"></div>
  
  <!-- Cabe√ßalho -->
  <div class="header">
    <div class="under-construction"><img src="https://i8.glitter-graphics.org/pub/2131/2131178p0y8xu87i7.gif" alt=""></div>
    <h1>PORTAL ALIEN√çGENA</h1>
    <p style=" margin: 5px 0;">Seu reposit√≥rio interdimensional de imagens!</p>
  </div>
  
  <div class="container">
    <!-- Marquesina estilo Geocities -->
    <div class="marquee">
      <marquee behavior="scroll" direction="left">
        <img src="https://i8.glitter-graphics.org/pub/53/53578nav6r4cs2b.gif" alt="">
        <img src="https://blob.gifcities.org/gifcities/7SS7YKIV7AMZEUSVABMSN5HLJXL5ISUQ.gif" alt="">
        <img src="https://i3.glitter-graphics.org/pub/634/ÊûÅÈÄüÈ£ûËâábibl.gif" alt="">
        <img src="https://web.archive.org/web/20040825152619if_/http://mx.geocities.com:80/sergiosmf/ojos.gif" alt="">
        <img src="https://i8.glitter-graphics.org/pub/53/53578nav6r4cs2b.gif" alt="">
        <img src="https://dl.glitter-graphics.com/pub/3169/3169383hs1c7fnsqz.gif" alt="">
        <img src="https://i3.glitter-graphics.org/pub/634/634873vc4mnsbibl.gif" alt="">
        <img src="https://dl.glitter-graphics.com/pub/3169/3169382i99t3jl2jl.gif" alt="">
        <img src="https://i8.glitter-graphics.org/pub/53/53578nav6r4cs2b.gif" alt="">
        <img src="ÊûÅÈÄüÈ£ûËâái2.glitter-graphics.org/pub/890/890632q89i8lr5nt.gif" alt="">
        <img src="https://i3.glitter-graphics.org/pub/634/634873vc4mnsbibl.gif" alt="">
      </marquee>
    </div>
    
    <!-- Se√ß√£o de Upload -->
    <div class="upload-section">
      <h2>TRANSMISS√ÉO INTERGAL√ÅCTICA</h2>
      <form id="uploadForm">
        <div class="input-group">
          <input type="file" class="form-control" id="fileInput" name="file" required accept="image/*">
          <button type="submit" class="btn btn-primary">TRANSMITIR!</button>
        </div>
      </form>
      <div id="status" class="mt-3">‚úß ‚úß ‚úß AGUARDANDO TRANSMISS√ÉO ‚úß ‚úß ‚úß</div>
    </div>
    
    <!-- Separador -->
    <div class="separator">
      <div class="separator-line"></div>
      <div class="separator-line"></div>
    </div>
    
    <!-- Galeria de Imagens -->
    <div class="gallery-section">
      <h2>ARQUIVOS EXTRATERRESTRES</h2>
      <div id="gallery" class="row"></div>
    </div>
  </div>
  
  <!-- Rodap√© -->
  <div class="footer">
    <div class="container">
      ¬© 2025 Galaxia Alien - Todos os universos reservados
      <br>
      <a href="#">Portal Central</a> | <a href="#">Sobre n√≥s</a> | <a href="#">Contato alien√≠gena</a> | <a href="#">Livro de visitas</a>
    </div>
  </div>
  
  <!-- Contador de visitantes -->
  <div class="counter">
    <i class="fas fa-users"></i> VISITANTES: <span id="visitorCount">001</span>
  </div>
  
  <!-- Modal para visualiza√ß√£o de imagem -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">VISUALIZA√á√ÉO INTERDIMENSIONAL</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <img src="" alt="Imagem ampliada">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="downloadBtn">
            <i class="fas fa-download"></i> SALVAR NO DISPOSITIVO TERRESTRE
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">FECHAR PORTAL</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal para renomear -->
  <div class="modal fade" id="renameModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">RENOMEAR TRANSMISS√ÉO</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newFilename" class="form-label">Novo c√≥digo de identifica√ß√£o:</label>
            <input type="text" class="form-control" id="newFilename" placeholder="Digite o novo identificador com extens√£o">
          </div>
          <input type="hidden" id="renameUrl">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn-save" id="confirmRename">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- REFER√äNCIAS AOS ELEMENTOS DO DOM ---
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const statusEl = document.getElementById('status');
    const galleryEl = document.getElementById('gallery');
    const visitorCount = document.getElementById('visitorCount');
    
    // Modais
    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
    
    // Elementos do modal de imagem
    const imageModalImg = document.querySelector('#imageModal img');
    const downloadBtn = document.getElementById('downloadBtn');
    
    // Elementos do modal de renomear
    const newFilenameInput = document.getElementById('newFilename');
    const confirmRenameBtn = document.getElementById('confirmRename');
    const renameUrlInput = document.getElementById('renameUrl');
    
    let currentBlobUrl = '';
    let currentImageUrl = '';

    // --- CONTADOR DE VISITANTES ---
    document.addEventListener('DOMContentLoaded', () => {
      let visits = localStorage.getItem('visits');
      visits = visits ? parseInt(visits) + 1 : 1;
      localStorage.setItem('visits', visits);
      visitorCount.textContent = visits.toString().padStart(3, '0');
    });

    // --- FUN√á√ÉO PARA CARREGAR A GALERIA ---
    async function loadGallery() {
      galleryEl.innerHTML = '<p class="text-center" style="color: #0f0;">Sintonizando transmiss√µes...</p>';
      
      try {
        const response = await fetch('/api/files');
        if (!response.ok) {
          throw new Error('Falha na conex√£o interdimensional.');
        }
        const files = await response.json();
        galleryÊûÅÈÄüÈ£ûËâá.innerHTML = '';
        
        if (files.length === 0) {
          galleryEl.innerHTML = '<p class="text-center" style="color: #0f0;">Nenhuma transmiss√£o detectada. Seja o primeiro a transmitir!</p>';
          return;
        }
        
        files.forEach(file => {
          const col = document.createElement('div');
          col.className = 'col-lg-3 col-md-4 col-sm-6 mb-4 gallery-item';
          
          const card = `
            <div class="card h-100 shadow-sm">
                <img src="${file.url}" class="card-img-top" alt="${file.pathname}" data-url="${file.url}">
                <div class="card-body text-center">
                    <p classÊûÅÈÄüÈ£ûËâácard-text small" title="${file.pathname}">
                        ${file.pathname.length > 20 ? file.pathname.substring(0, 20) + '...' : file.pathname}
                    </p>
                </div>
                <div class="card-footer">
                  <div class="action-buttons">
                    <button class="btn btn-rename" data-url="${file.url}" data-pathname="${file.pathname}">
                      <i class="fas fa-edit"></i> Recodificar
                    </button>
                    <button class="btn btn-delete" data-url="${file.url}">
                      <i class="fas fa-trash"></i> Deletar
                    </button>
                  </div>
                  <button class="btn btn-save" data-url="${file.url}" data-filename="${file.pathname}">
                    <i class="fas fa-download"></i> Decodificar
                  </button>
                </div>
            </div>`;
          
          col.innerHTML = card;
          galleryEl.appendChild(col);
        });

        // Adicionar event listeners
        addEventListeners();

      } catch (error) {
        galleryEl.innerHTML = `<p class="text-center" style="color: #f00;">Erro na conex√£o: ${error.message}</p>`;
      }
    }

    // --- ADICIONAR EVENT LISTENERS ---
    function addEventListeners() {
      // Visualizar imagem
      document.querySelectorAll('.card-img-top').forEach(img => {
        img.addEventListener('click', (e) => {
          currentImageUrl = e.target.getAttribute('data-url') || e.target.src;
          imageModalImg.src = currentImageUrl;
          imageModal.show();
        });
      });
      
      // Bot√£o de salvar (download)
      document.querySelectorAll('.btn-save').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const url = e.target.getAttribute('data-url');
          const filename = e.target.getAttribute('data-filename');
          downloadImage(url, filename);
        });
      });
      
      // Bot√£o de renomear
      document.querySelectorAll('.btn-rename').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const url = e.target.getAttribute('data-url');
          const pathname = e.target.getAttribute('data-pathname');
          openRenameModal(url, pathname);
        });
      });
      
      // Bot√£o de excluir
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const url = e.target.getAttribute('data-url');
          deleteImage(url);
        });
      });
    }

    // --- FUN√á√ÉO PARA ABRIR MODAL DE RENOMEAR ---
    function openRenameModal(url, currentName) {
      currentBlobUrl = url;
      newFilenameInput.value = currentName;
      renameUrlInput.value = url;
      renameModal.show();
    }

    // --- FUN√á√ÉO PARA RENOMEAR IMAGEM ---
    async function renameImage(url, newFilename) {
      try {
        const response = await fetch('/api/rename', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            url, 
            newFilename 
          }),
        });
        
        const result = await response.json();
        
        if (response.ok) {
          statusEl.innerHTML = `<span>‚úÖ Transmiss√£o recodificada para: ${newFilename}</span>`;
          statusEl.className = 'mt-3 text-center text-success';
          loadGallery();
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        statusEl.innerHTML = `<span>‚ùå Erro na recodifica√ß√£o: ${error.message}</span>`;
        statusEl.className = 'mt-3 text-center text-danger';
      }
    }

    // --- FUN√á√ÉO PARA EXCLUIR IMAGEM ---
    async function deleteImage(url) {
      if (!confirm('Confirmar exclus√£o da transmiss√£o?')) return;
      
      try {
        const response = await fetch('/api/delete', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ url }),
        });
        
        const result = await response.json();
        
        if (response.ok) {
          statusEl.innerHTML = `<span>üóëÔ∏è Transmiss√£o deletada!</span>`;
          statusEl.className = 'mt-3 text-center text-success';
          loadGallery();
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        statusEl.innerHTML = `<span>‚ùå Erro na exclus√£o: ${error.message}</span>`;
        statusEl.className = 'mt-3 text-center text-danger';
      }
    }

    function downloadImage(url, filename) {
      fetch(url)
        .then(response => response.blob())
        .then(blob => {
          const blobUrl = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = filename || 'imagem.jpg';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(blobUrl);
        })
        .catch(error => {
          console.error('Erro ao baixar a imagem:', error);
          alert('Falha na decodifica√ß√£o. Tente novamente.');
        });
    }

    // --- EVENTO DE UPLOAD ---
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const file = fileInput.files[0];
      if (!file) return;
      
      statusEl.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Transmitindo...';
      statusEl.className = 'mt-3 text-center text-primary';
      
      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          headers: {
            'x-vercel-filename': file.name,
            'Content-Type': file.type,
          },
          body: file,
        });
        
        const newBlob = await response.json();
        
        if (response.ok) {
          statusEl.innerHTML = `<span>‚úÖ Transmiss√£o bem-sucedida! ${file.name}</span>`;
          statusEl.className = 'mt-3 text-center text-success';
          form.reset();
          loadGallery();
        } else {
          throw new Error(newBlob.message);
        }
      } catch (error) {
        statusEl.innerHTML = `<span>‚ùå Falha na transmiss√£o: ${error.message}</span>`;
        statusEl.className = 'mt-3 text-center text-danger';
      }
    });

    // --- CONFIGURAR EVENTO DE CONFIRMA√á√ÉO DE RENOMEAR ---
    confirmRenameBtn.addEventListener('click', () => {
      const newFilename = newFilenameInput.value.trim();
      if (newFilename) {
        renameImage(currentBlobUrl, newFilename);
        renameModal.hide();
      } else {
        alert('Insira um novo c√≥digo de identifica√ß√£o!');
      }
    });

    // --- CONFIGURAR BOT√ÉO DE DOWNLOAD NO MODAL ---
    downloadBtn.addEventListener('click', () => {
      const filename = currentImageUrl.split('/').pop();
      downloadImage(currentImageUrl, filename);
    });

    // --- CARREGAMENTO INICIAL DA APLICA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', loadGallery);
  </script>
</body>
</html>